# PRD: Phase 5 — Email Delivery (Mailgun)

## Overview

**Phase:** 5
**Title:** Email Delivery (Mailgun)
**Goal:** Send a branded HTML scorecard email to the founder after assessment completion, with delivery tracking via webhooks.
**Priority:** High — lead nurturing and results delivery
**Estimated Effort:** 1–2 days
**Depends On:** Phase 4 (Results Page)
**Can Be Parallel With:** Phase 6 (Brevo CRM Sync), Phase 7 (Admin Dashboard)

---

## Problem Statement

Founders who complete the assessment need to receive their results via email for future reference. This email serves as both a value delivery mechanism (the scorecard summary) and a lead nurturing touchpoint (CTA to book a consultation). Email delivery must be reliable, tracked, and never block the user from seeing their results in the browser.

---

## Success Criteria (Definition of Done)

- [ ] Assessment completion triggers email delivery
- [ ] HTML email renders correctly in Gmail, Outlook, and Apple Mail
- [ ] Email contains: score summary, top 3 gaps, CTA button, results link
- [ ] Retry logic works (3 attempts with exponential backoff)
- [ ] Mailgun webhook events are received and stored (delivery, opens, clicks, bounces)
- [ ] Email send never blocks results page display
- [ ] `email_logs` table is updated with status changes
- [ ] Unsubscribe link works

---

## Detailed Requirements

### 5.1 — HTML Email Template

**From:** `Investor Readiness Assessment <info@e3digital.net>`
**Reply-To:** `razaq@e3.digital`
**Subject:** "Your Investor Readiness Score: [SCORE]/100 — [READINESS_LEVEL]"

**Email structure (top to bottom):**

1. **Header**
   - E3 Digital logo (hosted image URL, not inline)
   - "Your Investor Readiness Assessment Results"

2. **Score Summary**
   - Large score number with colour (inline CSS, not dynamic — use a pre-rendered image or HTML/CSS gauge)
   - Readiness level badge text
   - 1-line summary based on readiness level

3. **Category Highlights**
   - Top 3 strongest categories (green, with scores)
   - Top 3 weakest categories (red/orange, with scores)
   - Simple text-based format (email clients don't support complex CSS)

4. **Top 3 Gaps**
   - For each gap:
     - Gap title (bold)
     - Brief description
     - 1-2 recommended actions

5. **CTA Button**
   - "View Your Full Results →" — links to `/results/[id]`
   - "Book a Free Strategy Call →" — links to Zoho booking URL
   - Both buttons styled as inline CSS buttons (table-based for email compatibility)

6. **Footer**
   - "This assessment was generated by E3 Digital's Investor Readiness Assessment tool."
   - Link to e3.digital
   - Unsubscribe link: "You received this email because you completed an investor readiness assessment. [Unsubscribe]"
   - Physical address (required by CAN-SPAM/GDPR): E3 Digital office address

**Technical constraints:**
- All CSS must be inline (email clients strip `<style>` tags)
- Use table-based layout for maximum compatibility
- Images must be hosted (absolute URLs), not base64
- Max width: 600px
- Test with Litmus or Email on Acid (or manual testing across clients)

### 5.2 — Mailgun Send Function

**Integration:**
- Use Mailgun API (not SMTP) for sending
- Domain: `e3digital.net` (or subdomain like `mail.e3digital.net`)
- API endpoint: `https://api.eu.mailgun.net/v3/...` (EU region for GDPR)

**Function signature:**
```typescript
async function sendAssessmentEmail(params: {
  assessmentId: string;
  recipientEmail: string;
  recipientName: string;
  overallScore: number;
  readinessLevel: string;
  categoryScores: CategoryScore[];
  topGaps: Gap[];
  resultsUrl: string;
}): Promise<{ success: boolean; messageId?: string; error?: string }>
```

**Environment variables required:**
```
MAILGUN_API_KEY=key-...
MAILGUN_DOMAIN=e3digital.net
MAILGUN_FROM_EMAIL=info@e3digital.net
MAILGUN_REPLY_TO=razaq@e3.digital
```

**MANUAL STEP:** Set up Mailgun account, verify domain (SPF, DKIM, DMARC records), obtain API key.

### 5.3 — Retry Logic

**Strategy:**
- Attempt 1: immediate
- Attempt 2: after 5 seconds (if attempt 1 failed)
- Attempt 3: after 30 seconds (if attempt 2 failed)
- After 3 failures: mark as `failed` in `email_logs`, log to Sentry

**Failure types:**
- Network error: retry
- Mailgun 5xx: retry
- Mailgun 4xx (bad request): do NOT retry (fix the request)
- Mailgun 401/403: do NOT retry (auth issue, alert Sentry)

**Logging:**
- Log each attempt (success/failure) to `email_logs` table
- Update `retry_count` on each attempt
- Store `failure_reason` on final failure

### 5.4 — Mailgun Webhook Endpoint

**Route:** `POST /api/webhooks/mailgun`

**Events to track:**
- `delivered` — email reached recipient's mail server
- `opened` — recipient opened the email (pixel tracking)
- `clicked` — recipient clicked a link in the email
- `failed` — permanent delivery failure
- `complained` — recipient marked as spam

**Webhook verification:**
- Verify Mailgun webhook signature (timestamp + token + signature)
- Reject invalid signatures with 403

**Database updates:**
- Match webhook to `email_logs` record via `message_id`
- Update status and timestamp fields accordingly
- `delivered` → set `delivered_at`
- `opened` → set `opened_at`
- `clicked` → set `clicked_at`
- `failed` → set `failed_at` + `failure_reason`

**Environment variables:**
```
MAILGUN_WEBHOOK_SIGNING_KEY=...
```

### 5.5 — Wire Into Submission Flow

**Integration point:** After successful assessment save and AI scoring in Phase 3 pipeline

**Behaviour:**
- Email send is ASYNC and NON-BLOCKING
- The results page redirect happens immediately — do NOT wait for email
- Fire-and-forget pattern with internal retry handling
- If email fails after all retries, the user still has their results page

**Implementation:**
```typescript
// In assessment submission handler, after saving scores:
// Do NOT await this — fire and forget
sendAssessmentEmail({...}).catch(error => {
  logger.error('Email send failed', { assessmentId, error });
  Sentry.captureException(error);
});
```

### 5.6 — Update email_logs on Events

- On email send attempt: create `email_logs` record with status `pending`
- On successful send: update to `sent`, store `message_id` and `sent_at`
- On webhook events: update status and timestamps as per 5.4
- On final failure: update to `failed` with `failure_reason`
- Update `email_sent` boolean on `assessments` table when status reaches `sent` or `delivered`

---

## Technical Architecture

- **API Route:** `src/app/api/webhooks/mailgun/route.ts`
- **Email Service:** `src/lib/email/mailgun.ts` (Mailgun API integration)
- **Email Template:** `src/lib/email/templates/assessment-results.ts` (HTML template builder)
- **Utils:** `src/lib/email/retry.ts` (retry logic)

---

## Dependencies

- **Upstream:** Phase 3 (submission triggers email), Phase 4 (email links to results page)
- **Downstream:** Phase 7 (admin dashboard shows email status)

---

## Out of Scope

- Follow-up email sequences (nurture campaigns — handled by Brevo in Phase 6)
- Email template editor/customization
- A/B testing of email content
- Transactional email for account-related actions (password reset, etc. — handled by Clerk)
